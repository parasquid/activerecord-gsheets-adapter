require "spec_helper"
require "gsheets/work_sheet"

describe Gsheets::WorkSheet do
  Given(:ws_class) { Gsheets::WorkSheet }
  Given(:api_payload_cells) { <<-JSON
{"version":"1.0","encoding":"UTF-8","feed":{"xmlns":"http://www.w3.org/2005/Atom","xmlns$openSearch":"http://a9.com/-/spec/opensearchrss/1.0/","xmlns$batch":"http://schemas.google.com/gdata/batch","xmlns$gs":"http://schemas.google.com/spreadsheets/2006","id":{"$t":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full"},"updated":{"$t":"2015-12-05T12:06:17.850Z"},"category":[{"scheme":"http://schemas.google.com/spreadsheets/2006","term":"http://schemas.google.com/spreadsheets/2006#cell"}],"title":{"type":"text","$t":"Sheet1"},"link":[{"rel":"alternate","type":"application/atom+xml","href":"https://docs.google.com/spreadsheets/d/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/edit"},{"rel":"http://schemas.google.com/g/2005#feed","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full"},{"rel":"http://schemas.google.com/g/2005#post","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full"},{"rel":"http://schemas.google.com/g/2005#batch","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/batch"},{"rel":"self","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full?alt\u003djson\u0026min-row\u003d1\u0026max-row\u003d1"}],"author":[{"name":{"$t":"tristan.gomez"},"email":{"$t":"tristan.gomez@gmail.com"}}],"openSearch$totalResults":{"$t":"4"},"openSearch$startIndex":{"$t":"1"},"gs$rowCount":{"$t":"100"},"gs$colCount":{"$t":"21"},"entry":[{"id":{"$t":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C1"},"updated":{"$t":"2015-12-05T12:06:17.850Z"},"category":[{"scheme":"http://schemas.google.com/spreadsheets/2006","term":"http://schemas.google.com/spreadsheets/2006#cell"}],"title":{"type":"text","$t":"A1"},"content":{"type":"text","$t":"id"},"link":[{"rel":"self","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C1"},{"rel":"edit","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C1/2l7"}],"gs$cell":{"row":"1","col":"1","inputValue":"id","$t":"id"}},{"id":{"$t":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C2"},"updated":{"$t":"2015-12-05T12:06:17.850Z"},"category":[{"scheme":"http://schemas.google.com/spreadsheets/2006","term":"http://schemas.google.com/spreadsheets/2006#cell"}],"title":{"type":"text","$t":"B1"},"content":{"type":"text","$t":"age"},"link":[{"rel":"self","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C2"},{"rel":"edit","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C2/a1nun"}],"gs$cell":{"row":"1","col":"2","inputValue":"age","$t":"age"}},{"id":{"$t":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C3"},"updated":{"$t":"2015-12-05T12:06:17.850Z"},"category":[{"scheme":"http://schemas.google.com/spreadsheets/2006","term":"http://schemas.google.com/spreadsheets/2006#cell"}],"title":{"type":"text","$t":"C1"},"content":{"type":"text","$t":"height"},"link":[{"rel":"self","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C3"},{"rel":"edit","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C3/erlxrb"}],"gs$cell":{"row":"1","col":"3","inputValue":"height","$t":"height"}},{"id":{"$t":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C4"},"updated":{"$t":"2015-12-05T12:06:17.850Z"},"category":[{"scheme":"http://schemas.google.com/spreadsheets/2006","term":"http://schemas.google.com/spreadsheets/2006#cell"}],"title":{"type":"text","$t":"D1"},"content":{"type":"text","$t":"email"},"link":[{"rel":"self","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C4"},{"rel":"edit","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/cells/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/R1C4/1vihek"}],"gs$cell":{"row":"1","col":"4","inputValue":"email","$t":"email"}}]}}
JSON
  }
  Given(:api_payload_list) { <<-JSON
{"version":"1.0","encoding":"UTF-8","feed":{"xmlns":"http://www.w3.org/2005/Atom","xmlns$openSearch":"http://a9.com/-/spec/opensearchrss/1.0/","xmlns$gsx":"http://schemas.google.com/spreadsheets/2006/extended","id":{"$t":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full"},"updated":{"$t":"2015-12-09T10:34:02.448Z"},"category":[{"scheme":"http://schemas.google.com/spreadsheets/2006","term":"http://schemas.google.com/spreadsheets/2006#list"}],"title":{"type":"text","$t":"Copy of Sheet1"},"link":[{"rel":"alternate","type":"application/atom+xml","href":"https://docs.google.com/spreadsheets/d/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/edit"},{"rel":"http://schemas.google.com/g/2005#feed","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full"},{"rel":"http://schemas.google.com/g/2005#post","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full"},{"rel":"self","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full?alt\u003djson"}],"author":[{"name":{"$t":"tristan.gomez"},"email":{"$t":"tristan.gomez@gmail.com"}}],"openSearch$totalResults":{"$t":"3"},"openSearch$startIndex":{"$t":"1"},"entry":[{"id":{"$t":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/cokwr"},"updated":{"$t":"2015-12-09T10:34:02.448Z"},"category":[{"scheme":"http://schemas.google.com/spreadsheets/2006","term":"http://schemas.google.com/spreadsheets/2006#list"}],"title":{"type":"text","$t":"1"},"content":{"type":"text","$t":"mister: 34, fantastic: 173, voyage: tristan.gomez@gmail.com"},"link":[{"rel":"self","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/cokwr"},{"rel":"edit","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/cokwr/3mdk5gio2hl"}],"gsx$id":{"$t":"1"},"gsx$mister":{"$t":"34"},"gsx$fantastic":{"$t":"173"},"gsx$voyage":{"$t":"tristan.gomez@gmail.com"}},{"id":{"$t":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/cpzh4"},"updated":{"$t":"2015-12-09T10:34:02.448Z"},"category":[{"scheme":"http://schemas.google.com/spreadsheets/2006","term":"http://schemas.google.com/spreadsheets/2006#list"}],"title":{"type":"text","$t":"2"},"content":{"type":"text","$t":"mister: 99, fantastic: 463, voyage: test@example.com"},"link":[{"rel":"self","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/cpzh4"},{"rel":"edit","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/cpzh4/efian08mm2d"}],"gsx$id":{"$t":"2"},"gsx$mister":{"$t":"99"},"gsx$fantastic":{"$t":"463"},"gsx$voyage":{"$t":"test@example.com"}},{"id":{"$t":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/cre1l"},"updated":{"$t":"2015-12-09T10:34:02.448Z"},"category":[{"scheme":"http://schemas.google.com/spreadsheets/2006","term":"http://schemas.google.com/spreadsheets/2006#list"}],"title":{"type":"text","$t":"3"},"content":{"type":"text","$t":"mister: 44, fantastic: 555, voyage: another@example.com"},"link":[{"rel":"self","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/cre1l"},{"rel":"edit","type":"application/atom+xml","href":"https://spreadsheets.google.com/feeds/list/1YOf91Qpe6cK19_zkzBOoQ2IbYbtrIn8au_oFMPKqmcU/default/private/full/cre1l/1bf2pjn2cel"}],"gsx$id":{"$t":"3"},"gsx$mister":{"$t":"44"},"gsx$fantastic":{"$t":"555"},"gsx$voyage":{"$t":"another@example.com"}}]}}
JSON
  }
  Given(:session) { double("session", get_cells: OpenStruct.new(body: api_payload_cells), get_list: OpenStruct.new(body: api_payload_list)) }
  Given(:id) { "id" }
  Given(:grid_id) { "grid_id" }
  context "sanity check" do
    context "instantiation" do
      When(:ws_instance) { ws_class.new(session: session, id: id, grid_id: grid_id) }
      Then { ws_instance != nil }
    end
  end

  context "document contents" do
    context "headers" do
      Given(:ws_instance) { ws_class.new(session: session, id: id, grid_id: grid_id) }
      When(:headers) { ws_instance.headers }
      Then { headers != nil }
      Then { headers.include?("id") }
      Then { headers.include?("age") }
      Then { headers.include?("height") }
      Then { headers.include?("email") }
      Then { headers.size == 4 }
    end

    context "rows" do
      Given(:ws_instance) { ws_class.new(session: session, id: id, grid_id: grid_id) }
      When(:rows) { ws_instance.rows }
      Then { rows.count == 3 }
      Then { expect(rows).to include( {"mister"=>"34", "fantastic"=>"173", "voyage"=>"tristan.gomez@gmail.com" } ) }
      Then { expect(rows).to include( {"mister"=>"99", "fantastic"=>"463", "voyage"=>"test@example.com"} ) }
      Then { expect(rows).to include( {"mister"=>"44", "fantastic"=>"555", "voyage"=>"another@example.com" } ) }
    end
  end
end
